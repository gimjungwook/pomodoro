<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POMODORO</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #ffffff;
            --primary: #000000;
            --pixel-size: 4px;
        }

        .dark {
            --bg: #000000;
            --primary: #ffffff;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg);
            color: var(--primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            transition: background-color 0.3s, color 0.3s;
            padding: 20px;
            padding-top: 60px;
        }

        /* Pixel Border Mixin */
        .pixel-border {
            box-shadow:
                var(--pixel-size) 0 0 0 var(--primary),
                calc(var(--pixel-size) * -1) 0 0 0 var(--primary),
                0 var(--pixel-size) 0 0 var(--primary),
                0 calc(var(--pixel-size) * -1) 0 0 var(--primary),
                var(--pixel-size) var(--pixel-size) 0 0 var(--primary),
                calc(var(--pixel-size) * -1) var(--pixel-size) 0 0 var(--primary),
                var(--pixel-size) calc(var(--pixel-size) * -1) 0 0 var(--primary),
                calc(var(--pixel-size) * -1) calc(var(--pixel-size) * -1) 0 0 var(--primary);
        }

        .pixel-border-thin {
            box-shadow:
                2px 0 0 0 var(--primary),
                -2px 0 0 0 var(--primary),
                0 2px 0 0 var(--primary),
                0 -2px 0 0 var(--primary),
                2px 2px 0 0 var(--primary),
                -2px 2px 0 0 var(--primary),
                2px -2px 0 0 var(--primary),
                -2px -2px 0 0 var(--primary);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 800px;
            margin-bottom: 30px;
        }

        .title {
            font-size: 1.2rem;
            letter-spacing: 2px;
        }

        .theme-toggle {
            background: var(--bg);
            color: var(--primary);
            border: none;
            padding: 12px 16px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.1s;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: var(--bg);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            align-items: center;
            width: 100%;
            max-width: 500px;
        }

        /* Timer Section */
        .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Timer Container */
        .timer-container {
            text-align: center;
            padding: 40px 60px;
            margin-bottom: 30px;
            background: var(--bg);
        }

        .session-label {
            font-size: 0.8rem;
            margin-bottom: 20px;
            letter-spacing: 4px;
        }

        .session-label.break {
            animation: blink-smooth 2s ease-in-out infinite;
        }

        @keyframes blink-smooth {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @keyframes blink-pause {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .timer-display {
            font-size: 3.5rem;
            letter-spacing: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .timer-display {
                font-size: 2.5rem;
                letter-spacing: 4px;
            }
        }

        .timer-display.paused {
            animation: blink-pause 1.5s ease-in-out infinite;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            height: 16px;
            background: var(--bg);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            transition: width 1s linear;
        }

        .progress-pixels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 8px,
                var(--bg) 8px,
                var(--bg) 10px
            );
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            background: var(--bg);
            color: var(--primary);
            border: none;
            padding: 16px 32px;
            font-family: inherit;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.1s;
            letter-spacing: 2px;
        }

        .btn:hover {
            background: var(--primary);
            color: var(--bg);
        }

        .btn:active {
            transform: translate(2px, 2px);
        }

        .btn.active {
            background: var(--primary);
            color: var(--bg);
        }

        /* Mode Selection */
        .mode-selection {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-btn {
            background: var(--bg);
            color: var(--primary);
            border: none;
            padding: 12px 24px;
            font-family: inherit;
            font-size: 0.6rem;
            cursor: pointer;
            transition: all 0.1s;
        }

        .mode-btn:hover {
            background: var(--primary);
            color: var(--bg);
        }

        .mode-btn.active {
            background: var(--primary);
            color: var(--bg);
        }

        /* Heatmap Section - GitHub Style */
        .heatmap-section {
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: var(--bg);
            width: 100%;
        }

        .heatmap-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 15px;
        }

        .heatmap-title {
            font-size: 0.6rem;
            letter-spacing: 2px;
        }

        .heatmap-stats-inline {
            font-size: 0.5rem;
            opacity: 0.7;
        }

        /* GitHub-style Grid Container */
        .heatmap-container {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        /* Y-axis: Hour labels */
        .heatmap-hours {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding-top: 22px;
        }

        .hour-label {
            height: 16px;
            font-size: 0.35rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            opacity: 0.5;
        }

        .hour-label.visible {
            opacity: 0.8;
        }

        /* Grid area */
        .heatmap-grid-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* X-axis: Date labels */
        .heatmap-dates {
            display: flex;
            gap: 2px;
            height: 18px;
            margin-bottom: 4px;
        }

        .date-label {
            width: 16px;
            font-size: 0.35rem;
            text-align: center;
            opacity: 0.6;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        /* Main grid */
        .heatmap-grid {
            display: flex;
            gap: 2px;
        }

        /* Each day column */
        .heatmap-day {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        /* Each cell */
        .heatmap-cell {
            width: 16px;
            height: 16px;
            background: var(--bg);
            border: 1px solid var(--primary);
            opacity: 0.3;
            transition: all 0.2s;
        }

        .heatmap-cell.filled-1 { opacity: 0.4; background: var(--primary); }
        .heatmap-cell.filled-2 { opacity: 0.55; background: var(--primary); }
        .heatmap-cell.filled-3 { opacity: 0.7; background: var(--primary); }
        .heatmap-cell.filled-4 { opacity: 0.85; background: var(--primary); }
        .heatmap-cell.filled-5 { opacity: 1; background: var(--primary); }

        .heatmap-cell.today {
            box-shadow: inset 0 0 0 2px var(--bg), 0 0 0 1px var(--primary);
        }

        /* Tooltip */
        .heatmap-tooltip {
            position: fixed;
            background: var(--primary);
            color: var(--bg);
            padding: 8px 12px;
            font-size: 0.4rem;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.15s;
            line-height: 1.6;
        }

        .heatmap-tooltip.show {
            opacity: 1;
        }

        /* Stats */
        .heatmap-stats {
            margin-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-time {
            font-size: 0.6rem;
        }

        .total-sessions {
            font-size: 0.45rem;
            opacity: 0.6;
        }

        /* Legend */
        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.35rem;
            opacity: 0.6;
        }

        .legend-cell {
            width: 8px;
            height: 8px;
            border: 1px solid var(--primary);
        }

        .legend-cell.l1 { opacity: 0.3; }
        .legend-cell.l2 { opacity: 0.5; background: var(--primary); }
        .legend-cell.l3 { opacity: 0.7; background: var(--primary); }
        .legend-cell.l4 { opacity: 1; background: var(--primary); }

        /* Empty state */
        .heatmap-empty {
            padding: 40px 20px;
            text-align: center;
            font-size: 0.5rem;
            opacity: 0.5;
        }

        /* Session Log */
        .session-log {
            margin-top: 20px;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
        }

        .session-log-title {
            font-size: 0.5rem;
            margin-bottom: 10px;
            opacity: 0.6;
        }

        .session-entry {
            display: flex;
            justify-content: space-between;
            font-size: 0.4rem;
            padding: 5px 0;
            border-bottom: 1px dashed var(--primary);
            opacity: 0.8;
        }

        .session-entry:last-child {
            border-bottom: none;
        }

        /* Status indicator */
        .status-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 0.4rem;
            opacity: 0.5;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
        }

        .status-dot.saving {
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Notification permission button */
        .notification-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg);
            color: var(--primary);
            border: none;
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.5rem;
            cursor: pointer;
        }

        .notification-btn:hover {
            background: var(--primary);
            color: var(--bg);
        }

        .notification-btn.granted {
            opacity: 0.5;
        }

        /* Keyboard hint */
        .keyboard-hint {
            margin-top: 30px;
            font-size: 0.5rem;
            opacity: 0.4;
            text-align: center;
        }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .dark .confirm-modal {
            background: rgba(255,255,255,0.15);
        }

        .confirm-modal.show {
            display: flex;
        }

        .confirm-modal-content {
            background: var(--bg);
            padding: 40px 50px;
            text-align: center;
            max-width: 320px;
        }

        .confirm-modal h2 {
            font-size: 0.9rem;
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .confirm-modal p {
            font-size: 0.5rem;
            margin-bottom: 30px;
            line-height: 2;
            opacity: 0.7;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            background: var(--bg);
            color: var(--primary);
            border: none;
            padding: 14px 28px;
            font-family: inherit;
            font-size: 0.55rem;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.1s;
        }

        .confirm-btn:hover {
            background: var(--primary);
            color: var(--bg);
        }

        .confirm-btn.danger {
            background: var(--primary);
            color: var(--bg);
        }

        .confirm-btn.danger:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <!-- Tooltip -->
    <div class="heatmap-tooltip" id="heatmapTooltip"></div>

    <!-- Status indicator -->
    <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">SAVED</span>
    </div>

    <!-- Notification button -->
    <button class="notification-btn pixel-border-thin" id="notificationBtn" onclick="requestNotificationPermission()">
        NOTIFY
    </button>

    <!-- Confirm Modal -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-modal-content pixel-border">
            <h2 id="confirmTitle">CONFIRM</h2>
            <p id="confirmMessage">Are you sure?</p>
            <div class="confirm-modal-buttons">
                <button class="confirm-btn pixel-border-thin" id="confirmCancel">CANCEL</button>
                <button class="confirm-btn danger pixel-border-thin" id="confirmOk">OK</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <h1 class="title">POMODORO</h1>
        <button class="theme-toggle pixel-border" onclick="toggleTheme()">
            <span id="themeIcon">DARK</span>
        </button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Timer Section -->
        <div class="timer-section">
            <!-- Mode Selection -->
            <div class="mode-selection">
                <button class="mode-btn pixel-border active" id="mode25" onclick="setMode('25/5')">
                    25 / 5
                </button>
                <button class="mode-btn pixel-border" id="mode50" onclick="setMode('50/10')">
                    50 / 10
                </button>
            </div>

            <!-- Timer -->
            <div class="timer-container pixel-border">
                <div class="session-label" id="sessionLabel">WORK</div>
                <div class="timer-display" id="timerDisplay">25:00</div>
                <div class="progress-container pixel-border-thin">
                    <div class="progress-bar" id="progressBar" style="width: 100%"></div>
                    <div class="progress-pixels"></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <button class="btn pixel-border" id="startBtn" onclick="toggleTimer()">
                    START
                </button>
                <button class="btn pixel-border" onclick="resetTimer()">
                    RESET
                </button>
                <button class="btn pixel-border" onclick="skipSession()">
                    SKIP
                </button>
            </div>
        </div>

        <!-- Heatmap Section -->
        <div class="heatmap-section pixel-border">
            <div class="heatmap-header">
                <span class="heatmap-title">HISTORY</span>
                <span class="heatmap-stats-inline" id="totalTime">0H 0M</span>
            </div>

            <div class="heatmap-container" id="heatmapContainer">
                <!-- Y축: 시간 라벨 -->
                <div class="heatmap-hours" id="heatmapHours">
                    <!-- 00-23 시간 라벨 -->
                </div>

                <!-- 그리드 영역 -->
                <div class="heatmap-grid-wrapper">
                    <!-- X축: 날짜 라벨 -->
                    <div class="heatmap-dates" id="heatmapDates"></div>
                    <!-- 메인 그리드 -->
                    <div class="heatmap-grid" id="heatmapGrid"></div>
                </div>
            </div>

            <div class="heatmap-stats">
                <div class="total-sessions" id="totalSessions">0 SESSIONS</div>
                <div class="heatmap-legend">
                    <span>LESS</span>
                    <div class="legend-cell l1"></div>
                    <div class="legend-cell l2"></div>
                    <div class="legend-cell l3"></div>
                    <div class="legend-cell l4"></div>
                    <span>MORE</span>
                </div>
            </div>
        </div>
    </div>

    <div class="keyboard-hint">
        [SPACE] START/PAUSE &nbsp;&nbsp; [R] RESET
    </div>

    <script>
        // ==================== DATA STRUCTURES ====================
        // State
        let state = {
            mode: '25/5',
            isRunning: false,
            isWorkSession: true,
            timeRemaining: 25 * 60,
            totalTime: 25 * 60,
            completedPomodoros: 0,
            intervalId: null,
            sessionStartTime: null,  // When current session started
            lastTick: null           // Last update timestamp
        };

        // Mode configurations
        const modes = {
            '25/5': { work: 25 * 60, break: 5 * 60 },
            '50/10': { work: 50 * 60, break: 10 * 60 }
        };

        // ==================== DOM ELEMENTS ====================
        const timerDisplay = document.getElementById('timerDisplay');
        const sessionLabel = document.getElementById('sessionLabel');
        const startBtn = document.getElementById('startBtn');
        const progressBar = document.getElementById('progressBar');
        const themeIcon = document.getElementById('themeIcon');
        const notificationBtn = document.getElementById('notificationBtn');
        const heatmapContainer = document.getElementById('heatmapContainer');
        const heatmapHours = document.getElementById('heatmapHours');
        const heatmapDates = document.getElementById('heatmapDates');
        const heatmapGrid = document.getElementById('heatmapGrid');
        const heatmapTooltip = document.getElementById('heatmapTooltip');
        const totalTimeEl = document.getElementById('totalTime');
        const totalSessionsEl = document.getElementById('totalSessions');
        const confirmModal = document.getElementById('confirmModal');
        const confirmTitle = document.getElementById('confirmTitle');
        const confirmMessage = document.getElementById('confirmMessage');
        const confirmOk = document.getElementById('confirmOk');
        const confirmCancel = document.getElementById('confirmCancel');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // ==================== CUSTOM CONFIRM ====================
        function showConfirm(title, message, okText = 'OK') {
            return new Promise((resolve) => {
                confirmTitle.textContent = title;
                confirmMessage.textContent = message;
                confirmOk.textContent = okText;
                confirmModal.classList.add('show');

                const handleOk = () => {
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const handleKeydown = (e) => {
                    if (e.key === 'Escape') handleCancel();
                    if (e.key === 'Enter') handleOk();
                };

                const cleanup = () => {
                    confirmModal.classList.remove('show');
                    confirmOk.removeEventListener('click', handleOk);
                    confirmCancel.removeEventListener('click', handleCancel);
                    document.removeEventListener('keydown', handleKeydown);
                };

                confirmOk.addEventListener('click', handleOk);
                confirmCancel.addEventListener('click', handleCancel);
                document.addEventListener('keydown', handleKeydown);
            });
        }

        // ==================== STORAGE FUNCTIONS ====================
        function getDateKey(date = new Date()) {
            return date.toISOString().split('T')[0];
        }

        function loadSessions() {
            const data = localStorage.getItem('pomodoroSessions');
            return data ? JSON.parse(data) : {};
        }

        function saveSessions(sessions) {
            localStorage.setItem('pomodoroSessions', JSON.stringify(sessions));
            showSaveIndicator();
        }

        function addSession(session) {
            const sessions = loadSessions();
            const dateKey = getDateKey();

            if (!sessions[dateKey]) {
                sessions[dateKey] = [];
            }

            sessions[dateKey].push(session);
            saveSessions(sessions);
            updateHeatmap();
        }

        function loadState() {
            const data = localStorage.getItem('pomodoroState');
            return data ? JSON.parse(data) : null;
        }

        function saveState() {
            const stateToSave = {
                mode: state.mode,
                isRunning: state.isRunning,
                isWorkSession: state.isWorkSession,
                timeRemaining: state.timeRemaining,
                totalTime: state.totalTime,
                completedPomodoros: state.completedPomodoros,
                sessionStartTime: state.sessionStartTime,
                lastTick: Date.now()
            };
            localStorage.setItem('pomodoroState', JSON.stringify(stateToSave));
            showSaveIndicator();
        }

        function clearState() {
            localStorage.removeItem('pomodoroState');
        }

        function showSaveIndicator() {
            statusDot.classList.add('saving');
            statusText.textContent = 'SAVING...';
            setTimeout(() => {
                statusDot.classList.remove('saving');
                statusText.textContent = 'SAVED';
            }, 500);
        }

        // ==================== RESUME LOGIC ====================
        function checkForResume() {
            const savedState = loadState();

            if (savedState && savedState.isRunning) {
                // Calculate elapsed time since last tick
                const elapsed = Math.floor((Date.now() - savedState.lastTick) / 1000);
                const newTimeRemaining = savedState.timeRemaining - elapsed;

                if (newTimeRemaining > 0) {
                    // 자동으로 이어서 진행
                    state.mode = savedState.mode;
                    state.isWorkSession = savedState.isWorkSession;
                    state.timeRemaining = newTimeRemaining;
                    state.totalTime = savedState.totalTime;
                    state.completedPomodoros = savedState.completedPomodoros;
                    state.sessionStartTime = savedState.sessionStartTime;

                    updateDisplay();
                    updateProgress();
                    updateSessionLabel();
                    updateModeButtons();
                    updatePomodoroCounter();

                    // 자동 시작
                    startTimer();
                    return true;
                } else {
                    // Session would have completed
                    handleMissedCompletion(savedState, elapsed);
                    return false;
                }
            } else if (savedState) {
                // Was paused, just restore state
                restoreState(savedState);
                return false;
            }
            return false;
        }

        function handleMissedCompletion(savedState, elapsed) {
            // Record the completed session
            if (savedState.isWorkSession && savedState.sessionStartTime) {
                const startTime = new Date(savedState.sessionStartTime);
                const duration = Math.floor((savedState.totalTime) / 60);

                addSession({
                    startTime: formatTime(startTime),
                    endTime: formatTime(new Date(savedState.sessionStartTime + savedState.totalTime * 1000)),
                    duration: duration,
                    type: 'work',
                    completed: true
                });

                state.completedPomodoros = savedState.completedPomodoros + 1;
            }

            // Reset to next session
            state.mode = savedState.mode;
            state.isWorkSession = !savedState.isWorkSession;
            state.timeRemaining = state.isWorkSession
                ? modes[state.mode].work
                : modes[state.mode].break;
            state.totalTime = state.timeRemaining;

            updateDisplay();
            updateProgress();
            updateSessionLabel();
            updateModeButtons();
            updatePomodoroCounter();
            clearState();
        }

        function restoreState(savedState) {
            state.mode = savedState.mode;
            state.isWorkSession = savedState.isWorkSession;
            state.timeRemaining = savedState.timeRemaining;
            state.totalTime = savedState.totalTime;
            state.completedPomodoros = savedState.completedPomodoros;

            updateDisplay();
            updateProgress();
            updateSessionLabel();
            updateModeButtons();
            updatePomodoroCounter();
        }

        // ==================== TIMER FUNCTIONS ====================
        function toggleTimer() {
            if (state.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            state.isRunning = true;
            state.lastTick = Date.now();

            if (!state.sessionStartTime) {
                state.sessionStartTime = Date.now();
            }

            startBtn.textContent = 'PAUSE';
            startBtn.classList.add('active');
            timerDisplay.classList.remove('paused');

            saveState();

            state.intervalId = setInterval(() => {
                state.timeRemaining--;
                state.lastTick = Date.now();

                updateDisplay();
                updateProgress();
                updateDocumentTitle();

                // Save state every 10 seconds
                if (state.timeRemaining % 10 === 0) {
                    saveState();
                }

                // Update heatmap every minute (실시간 반영)
                if (state.isWorkSession && (state.totalTime - state.timeRemaining) % 60 === 0) {
                    updateHeatmap();
                }

                if (state.timeRemaining <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        function pauseTimer() {
            state.isRunning = false;
            startBtn.textContent = 'START';
            startBtn.classList.remove('active');
            timerDisplay.classList.add('paused');
            clearInterval(state.intervalId);
            document.title = 'POMODORO';

            saveState();
        }

        async function resetTimer() {
            // 진행 중이거나 시작된 세션이 있으면 확인
            const hasProgress = state.timeRemaining < state.totalTime;
            if (state.isRunning || hasProgress) {
                const confirmed = await showConfirm(
                    'RESET?',
                    'Current progress will be lost.',
                    'RESET'
                );
                if (!confirmed) return;
            }

            const wasRunning = state.isRunning;
            pauseTimer();

            // If was a work session and had some progress, record partial session
            if (wasRunning && state.isWorkSession && state.sessionStartTime) {
                const elapsed = Math.floor((state.totalTime - state.timeRemaining) / 60);
                if (elapsed >= 1) {
                    addSession({
                        startTime: formatTime(new Date(state.sessionStartTime)),
                        endTime: formatTime(new Date()),
                        duration: elapsed,
                        type: 'work',
                        completed: false
                    });
                }
            }

            state.isWorkSession = true;
            state.timeRemaining = modes[state.mode].work;
            state.totalTime = modes[state.mode].work;
            state.sessionStartTime = null;
            timerDisplay.classList.remove('paused');

            updateDisplay();
            updateProgress();
            updateSessionLabel();
            clearState();
        }

        async function skipSession() {
            const sessionType = state.isWorkSession ? 'WORK' : 'BREAK';
            const confirmed = await showConfirm(
                `SKIP ${sessionType}?`,
                'Move to next session.',
                'SKIP'
            );
            if (!confirmed) return;
            completeSession();
        }

        function completeSession() {
            pauseTimer();
            playSound();
            showNotification();

            // Record completed session
            if (state.isWorkSession && state.sessionStartTime) {
                addSession({
                    startTime: formatTime(new Date(state.sessionStartTime)),
                    endTime: formatTime(new Date()),
                    duration: Math.floor(state.totalTime / 60),
                    type: 'work',
                    completed: true
                });

                state.completedPomodoros++;
                updatePomodoroCounter();
            }

            // Switch to next session
            if (state.isWorkSession) {
                state.timeRemaining = modes[state.mode].break;
                state.totalTime = modes[state.mode].break;
            } else {
                state.timeRemaining = modes[state.mode].work;
                state.totalTime = modes[state.mode].work;
            }

            state.isWorkSession = !state.isWorkSession;
            state.sessionStartTime = null;

            updateDisplay();
            updateProgress();
            updateSessionLabel();
            clearState();
        }

        async function setMode(mode) {
            if (state.isRunning || state.timeRemaining < state.totalTime) {
                const confirmed = await showConfirm(
                    'CHANGE MODE?',
                    'Timer will be reset.',
                    'CHANGE'
                );
                if (!confirmed) return;
            }

            state.mode = mode;
            updateModeButtons();

            // 직접 리셋 (confirm 없이)
            pauseTimer();
            state.isWorkSession = true;
            state.timeRemaining = modes[state.mode].work;
            state.totalTime = modes[state.mode].work;
            state.sessionStartTime = null;
            timerDisplay.classList.remove('paused');
            updateDisplay();
            updateProgress();
            updateSessionLabel();
            clearState();
        }

        function updateModeButtons() {
            document.getElementById('mode25').classList.toggle('active', state.mode === '25/5');
            document.getElementById('mode50').classList.toggle('active', state.mode === '50/10');
        }

        // ==================== DISPLAY FUNCTIONS ====================
        function updateDisplay() {
            const minutes = Math.floor(state.timeRemaining / 60);
            const seconds = state.timeRemaining % 60;
            timerDisplay.textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            const progress = (state.timeRemaining / state.totalTime) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateSessionLabel() {
            if (state.isWorkSession) {
                sessionLabel.textContent = 'WORK';
                sessionLabel.classList.remove('break');
            } else {
                sessionLabel.textContent = 'BREAK';
                sessionLabel.classList.add('break');
            }
        }

        function updateDocumentTitle() {
            const minutes = Math.floor(state.timeRemaining / 60);
            const seconds = state.timeRemaining % 60;
            const time = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const session = state.isWorkSession ? 'WORK' : 'BREAK';
            document.title = `${time} - ${session}`;
        }

        function updatePomodoroCounter() {
            // 카운터 UI 제거됨 - 함수만 유지
        }

        // ==================== HEATMAP FUNCTIONS (GitHub Style) ====================
        function initHeatmap() {
            // Y축: 시간 라벨 생성 (00-23)
            heatmapHours.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const label = document.createElement('div');
                label.className = 'hour-label';
                // 6시간 단위로만 표시
                if (i % 6 === 0) {
                    label.textContent = i.toString().padStart(2, '0');
                    label.classList.add('visible');
                }
                heatmapHours.appendChild(label);
            }

            renderHeatmap();
        }

        function renderHeatmap() {
            const sessions = loadSessions();
            const dates = Object.keys(sessions).sort(); // 날짜순 정렬

            // 기록이 없으면 빈 상태 표시
            if (dates.length === 0) {
                heatmapDates.innerHTML = '';
                heatmapGrid.innerHTML = '<div class="heatmap-empty">NO DATA YET</div>';
                totalTimeEl.textContent = '0H 0M';
                totalSessionsEl.textContent = '0 SESSIONS';
                return;
            }

            // 전체 통계 계산
            let totalMinutes = 0;
            let totalSessions = 0;

            // 현재 진행 중인 세션 정보
            const todayKey = getDateKey(new Date());
            let currentSessionMinutes = 0;
            let currentSessionHour = -1;
            let currentSessionStartMinute = 0;

            if (state.isRunning && state.isWorkSession && state.sessionStartTime) {
                const elapsed = Math.floor((state.totalTime - state.timeRemaining) / 60);
                currentSessionMinutes = elapsed;
                const startDate = new Date(state.sessionStartTime);
                currentSessionHour = startDate.getHours();
                currentSessionStartMinute = startDate.getMinutes();
            }

            // 오늘 데이터가 없으면 추가
            if (currentSessionMinutes > 0 && !dates.includes(todayKey)) {
                dates.push(todayKey);
                dates.sort();
            }

            // 각 날짜별 시간대 데이터 계산
            const daysData = dates.map(dateKey => {
                const daySessions = sessions[dateKey] || [];
                const hoursData = new Array(24).fill(0);

                daySessions.forEach(session => {
                    if (session.type === 'work') {
                        const [hours, minutes] = session.startTime.split(':').map(Number);
                        const duration = session.duration;

                        let remaining = duration;
                        let currentHour = hours;
                        let currentMinute = minutes;

                        while (remaining > 0 && currentHour < 24) {
                            const minutesInThisHour = Math.min(remaining, 60 - currentMinute);
                            hoursData[currentHour] += minutesInThisHour;
                            remaining -= minutesInThisHour;
                            currentHour++;
                            currentMinute = 0;
                        }

                        totalMinutes += duration;
                        totalSessions++;
                    }
                });

                // 현재 진행 중인 세션 추가 (오늘만)
                if (dateKey === todayKey && currentSessionMinutes > 0) {
                    let remaining = currentSessionMinutes;
                    let hour = currentSessionHour;
                    let minute = currentSessionStartMinute;

                    while (remaining > 0 && hour < 24) {
                        const minutesInThisHour = Math.min(remaining, 60 - minute);
                        hoursData[hour] += minutesInThisHour;
                        remaining -= minutesInThisHour;
                        hour++;
                        minute = 0;
                    }

                    totalMinutes += currentSessionMinutes;
                }

                return { dateKey, hoursData };
            });

            // X축: 날짜 라벨 생성
            heatmapDates.innerHTML = '';

            daysData.forEach(({ dateKey }) => {
                const label = document.createElement('div');
                label.className = 'date-label';
                const [, , day] = dateKey.split('-');
                label.textContent = day;
                heatmapDates.appendChild(label);
            });

            // 그리드 생성
            heatmapGrid.innerHTML = '';

            daysData.forEach(({ dateKey, hoursData }) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'heatmap-day';

                for (let hour = 0; hour < 24; hour++) {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell';

                    // 채움 레벨 계산 (0-5)
                    const minutes = hoursData[hour];
                    if (minutes > 0) {
                        const level = Math.min(5, Math.ceil(minutes / 12)); // 12분 단위
                        cell.classList.add(`filled-${level}`);
                    }

                    // 오늘 표시
                    if (dateKey === todayKey) {
                        cell.classList.add('today');
                    }

                    // 툴팁 이벤트
                    cell.dataset.date = dateKey;
                    cell.dataset.hour = hour;
                    cell.dataset.minutes = minutes;

                    cell.addEventListener('mouseenter', showTooltip);
                    cell.addEventListener('mouseleave', hideTooltip);
                    cell.addEventListener('mousemove', moveTooltip);

                    dayColumn.appendChild(cell);
                }

                heatmapGrid.appendChild(dayColumn);
            });

            // 통계 업데이트
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;
            totalTimeEl.textContent = `${hours}H ${mins}M`;
            totalSessionsEl.textContent = `${totalSessions} SESSIONS`;
        }

        function updateHeatmap() {
            renderHeatmap();
        }

        // Tooltip functions
        function showTooltip(e) {
            const cell = e.target;
            const date = cell.dataset.date;
            const hour = cell.dataset.hour;
            const minutes = cell.dataset.minutes;

            const [year, month, day] = date.split('-');
            const hourNum = parseInt(hour);
            const minNum = parseInt(minutes);

            heatmapTooltip.innerHTML = `
                ${month}/${day} ${hourNum.toString().padStart(2, '0')}:00<br>
                ${minNum > 0 ? minNum + 'M STUDIED' : 'NO DATA'}
            `;
            heatmapTooltip.classList.add('show');
        }

        function hideTooltip() {
            heatmapTooltip.classList.remove('show');
        }

        function moveTooltip(e) {
            heatmapTooltip.style.left = (e.clientX + 12) + 'px';
            heatmapTooltip.style.top = (e.clientY + 12) + 'px';
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatTime(date) {
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatDate(date) {
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${month}/${day}`;
        }

        // ==================== THEME FUNCTIONS ====================
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const isDark = document.body.classList.contains('dark');
            themeIcon.textContent = isDark ? 'LIGHT' : 'DARK';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                themeIcon.textContent = 'LIGHT';
            }
        }

        // ==================== NOTIFICATION FUNCTIONS ====================
        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(updateNotificationButton);
            }
        }

        function updateNotificationButton() {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    notificationBtn.classList.add('granted');
                    notificationBtn.textContent = 'NOTIFY ON';
                } else if (Notification.permission === 'denied') {
                    notificationBtn.textContent = 'NOTIFY OFF';
                }
            }
        }

        function showNotification() {
            if ('Notification' in window && Notification.permission === 'granted') {
                const title = state.isWorkSession ? 'Work Complete!' : 'Break Over!';
                const body = state.isWorkSession ? 'Time for a break!' : 'Ready to focus!';
                new Notification(title, { body });
            }
        }

        // ==================== SOUND FUNCTION ====================
        function playSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            [0, 200, 400].forEach(delay => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.value = 800;
                    oscillator.type = 'square';

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                }, delay);
            });
        }

        // ==================== KEYBOARD SHORTCUTS ====================
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.code === 'Space') {
                e.preventDefault();
                toggleTimer();
            } else if (e.code === 'KeyR') {
                e.preventDefault();
                resetTimer();
            }
        });

        // ==================== VISIBILITY CHANGE ====================
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && state.isRunning) {
                saveState();
            } else if (!document.hidden && state.isRunning) {
                // Sync timer when tab becomes visible
                const savedState = loadState();
                if (savedState) {
                    const elapsed = Math.floor((Date.now() - savedState.lastTick) / 1000);
                    const newTime = savedState.timeRemaining - elapsed;

                    if (newTime > 0) {
                        state.timeRemaining = newTime;
                        updateDisplay();
                        updateProgress();
                    } else {
                        completeSession();
                    }
                }
            }
        });

        // ==================== BEFORE UNLOAD ====================
        window.addEventListener('beforeunload', () => {
            if (state.isRunning || state.timeRemaining < state.totalTime) {
                saveState();
            }
        });

        // ==================== INITIALIZE ====================
        function init() {
            loadTheme();
            updateNotificationButton();
            initHeatmap();

            // Check for resume
            if (!checkForResume()) {
                updateDisplay();
                updatePomodoroCounter();
            }
        }

        init();
    </script>
</body>
</html>
